-- ‚úÖ Prevent duplicate execution
if _G.ScriptAlreadyRunning then return end
_G.ScriptAlreadyRunning = true

-- ‚úÖ Config
local VALID_PLACE_ID = 126884695634066
local TeleportService = game:GetService("TeleportService")
local Players = game:GetService("Players")
local HttpService = game:GetService("HttpService")
local LocalPlayer = Players.LocalPlayer

-- ‚úÖ Ghi l·∫°i JobId hi·ªán t·∫°i n·∫øu ch∆∞a c√≥ (d√πng ƒë·ªÉ ki·ªÉm tra rejoin)
_G.LastJobId = _G.LastJobId or game.JobId
local currentJobId = game.JobId

-- ‚úÖ Function: Find a valid public server
local function findPublicServer()
    local cursor = ""
    local url = ("https://games.roblox.com/v1/games/%d/servers/Public?sortOrder=Asc&limit=100"):format(VALID_PLACE_ID)

    while true do
        local fullUrl = url .. (cursor ~= "" and "&cursor=" .. cursor or "")
        local success, result = pcall(function()
            return HttpService:JSONDecode(game:HttpGet(fullUrl))
        end)

        if success and result and result.data then
            for _, server in ipairs(result.data) do
                if server.playing <= 5 and server.id ~= game.JobId then
                    return server.id
                end
            end
            if result.nextPageCursor then
                cursor = result.nextPageCursor
            else
                break
            end
        else
            break
        end
    end
    return nil
end

-- ‚úÖ H√†m ki·ªÉm tra xem c√≥ c·∫ßn chuy·ªÉn server kh√¥ng
local function shouldTeleport()
    if game.PlaceId ~= VALID_PLACE_ID then return true end
    if game.PrivateServerId ~= "" and game.PrivateServerOwnerId ~= 0 then return true end
    if #Players:GetPlayers() > 5 then return true end
    return false
end

-- ‚úÖ N·∫øu server hi·ªán t·∫°i kh√¥ng h·ª£p l·ªá ‚Üí chuy·ªÉn server + l∆∞u JobId
if shouldTeleport() then
    warn("‚ùå Invalid server - teleporting to a valid one...")

    local newServer = findPublicServer()
    if newServer then
        _G.LastJobId = currentJobId -- Ghi l·∫°i JobId c≈© tr∆∞·ªõc khi chuy·ªÉn
        TeleportService:TeleportToPlaceInstance(VALID_PLACE_ID, newServer, LocalPlayer)
    else
        LocalPlayer:Kick("‚ùå Kh√¥ng t√¨m th·∫•y server c√¥ng khai h·ª£p l·ªá.")
    end
    return -- ‚ùå Kh√¥ng ch·∫°y script ch√≠nh hay ph·ª• l√∫c n√†y
end

-- ‚úÖ N·∫øu v·ª´a rejoin sau khi teleport ‚Üí ch·∫°y script ph·ª•
if _G.LastJobId and _G.LastJobId ~= currentJobId then
    print("üîÅ V·ª´a v√†o l·∫°i server sau khi teleport - ƒëang ch·∫°y script ph·ª•")
    _G.LastJobId = currentJobId

    pcall(function()
        loadstring(game:HttpGet("https://raw.githubusercontent.com/NoLag-id/No-Lag-HUB/refs/heads/main/Loader/LoaderV1.lua"))()
    end)
else
    print("‚úÖ V√†o ƒë√∫ng server ngay t·ª´ ƒë·∫ßu - KH√îNG ch·∫°y script ph·ª•")
end

-- ‚úÖ Cu·ªëi c√πng, lu√¥n ch·∫°y script ch√≠nh
print("‚úÖ ƒêang ch·∫°y script ch√≠nh...")
pcall(function()
    loadstring(game:HttpGet("https://raw.githubusercontent.com/namnnni2/Nam/refs/heads/main/AllInOne"))()
end)
