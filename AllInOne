-- ‚úÖ NgƒÉn script ch·∫°y nhi·ªÅu l·∫ßn
if _G.ScriptAlreadyRunning then return end
_G.ScriptAlreadyRunning = true

-- ‚úÖ X√≥a c·∫£nh b√°o c≈© n·∫øu c√≤n t·ªìn t·∫°i
local oldAlert = game.CoreGui:FindFirstChild("ReRunAlert")
if oldAlert then oldAlert:Destroy() end

-- ‚úÖ H√†m hi·ªÉn th·ªã th√¥ng b√°o ƒë∆°n gi·∫£n (ngo√†i UI m·ªù n·ªÅn)
local function showMessage(msg, color, name)
    local gui = Instance.new("ScreenGui", game.CoreGui)
    gui.Name = name or ("MessageUI_" .. tostring(math.random(1, 999999)))

    local label = Instance.new("TextLabel", gui)
    label.Size = UDim2.new(0.5, 0, 0.1, 0)
    label.Position = UDim2.new(0.25, 0, 0.85, 0)
    label.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
    label.TextColor3 = color or Color3.new(1, 1, 1)
    label.TextScaled = true
    label.Font = Enum.Font.GothamBold
    label.Text = msg
    label.ZIndex = 999

    task.delay(4, function()
        if gui.Name ~= "ReRunAlert" then gui:Destroy() end
    end)
end

-- ‚úÖ C·∫•u h√¨nh game v√† d·ªãch v·ª•
local VALID_PLACE_ID = 126884695634066
local TeleportService = game:GetService("TeleportService")
local Players = game:GetService("Players")
local HttpService = game:GetService("HttpService")
local LocalPlayer = Players.LocalPlayer

-- ‚úÖ Ghi l·∫°i JobId ƒë·ªÉ ph√°t hi·ªán teleport
_G.LastJobId = _G.LastJobId or game.JobId
local currentJobId = game.JobId

-- ‚úÖ T√¨m server h·ª£p l·ªá (‚â§5 ng∆∞·ªùi, kh√°c JobId, kh√¥ng VIP)
local function findPublicServer()
    local cursor = ""
    local url = ("https://games.roblox.com/v1/games/%d/servers/Public?sortOrder=Asc&limit=100"):format(VALID_PLACE_ID)

    while true do
        local fullUrl = url .. (cursor ~= "" and "&cursor=" .. cursor or "")
        local success, result = pcall(function()
            return HttpService:JSONDecode(game:HttpGet(fullUrl))
        end)

        if success and result and result.data then
            for _, server in ipairs(result.data) do
                if server.playing <= 5 and server.id ~= game.JobId then
                    return server.id
                end
            end
            if result.nextPageCursor then
                cursor = result.nextPageCursor
            else
                break
            end
        else
            break
        end
    end
    return nil
end

-- ‚úÖ Ki·ªÉm tra xem c√≥ c·∫ßn chuy·ªÉn server kh√¥ng
local function shouldTeleport()
    if game.PlaceId ~= VALID_PLACE_ID then return true end
    if game.PrivateServerId ~= "" and game.PrivateServerOwnerId ~= 0 then return true end
    if #Players:GetPlayers() > 5 then return true end
    return false
end

-- ‚úÖ N·∫øu server sai ‚Üí chuy·ªÉn server
if shouldTeleport() then
    -- üîÑ UI l√†m m·ªù n·ªÅn
    local switchGui = Instance.new("ScreenGui", game.CoreGui)
    switchGui.Name = "ServerSwitchUI"

    local background = Instance.new("Frame", switchGui)
    background.Size = UDim2.new(1, 0, 1, 0)
    background.BackgroundColor3 = Color3.new(0, 0, 0)
    background.BackgroundTransparency = 0.4

    local textLabel = Instance.new("TextLabel", background)
    textLabel.Size = UDim2.new(1, 0, 1, 0)
    textLabel.BackgroundTransparency = 1
    textLabel.Text = "üîÑ Switching to a better server..."
    textLabel.TextColor3 = Color3.fromRGB(255, 255, 0)
    textLabel.Font = Enum.Font.GothamBold
    textLabel.TextScaled = true

    local newServer = findPublicServer()
    if newServer then
        _G.LastJobId = currentJobId
        task.wait(2) -- ‚úÖ ƒê·ª£i 2 gi√¢y ƒë·ªÉ hi·ªÉn th·ªã UI
        TeleportService:TeleportToPlaceInstance(VALID_PLACE_ID, newServer, LocalPlayer)
    else
        LocalPlayer:Kick("‚ùå No suitable server found.")
    end
    return
end

-- ‚úÖ N·∫øu v·ª´a b·ªã teleport ‚Üí hi·ªÉn th·ªã c·∫£nh b√°o v√† ch·∫°y script ph·ª•
if _G.LastJobId and _G.LastJobId ~= currentJobId then
    _G.LastJobId = currentJobId
    showMessage("‚ö†Ô∏è Please re-run the script to continue", Color3.fromRGB(255, 180, 0), "ReRunAlert")

    -- ‚úÖ Ch·∫°y script ph·ª• sau khi teleport
    pcall(function()
        loadstring(game:HttpGet("https://raw.githubusercontent.com/NoLag-id/No-Lag-HUB/refs/heads/main/Loader/LoaderV1.lua"))()
    end)
    return
end

-- ‚úÖ N·∫øu ƒë√£ v√†o ƒë√∫ng server ‚Üí ch·∫°y script ch√≠nh
showMessage("‚úÖ Running main script...", Color3.fromRGB(0, 255, 0))

pcall(function()
    loadstring(game:HttpGet("https://raw.githubusercontent.com/namnnni2/GrowaGarden/refs/heads/main/NoLagHub"))()
end)
